<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podsjetnik za lijekove</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s, color 0.5s;
        }
        body.dark {
            background-color: #111827;
            color: #e5e7eb;
        }
        .card-container {
            opacity: 0;
            transform: translateY(20px);
            animation: fade-in 0.5s forwards;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
        }
        .card-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        @keyframes fade-in {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .card-container.taken {
            background-color: #d1d5db;
            opacity: 0.6;
        }
        body.dark .card-container.taken {
            background-color: #374151;
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal.open {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-500 font-sans">

    <!-- Kontejner za prijavu/registraciju -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-sm transform transition duration-500 hover:scale-105">
            <div class="text-center">
                <h2 id="auth-title" class="text-2xl font-bold text-gray-900 dark:text-white">Prijava</h2>
            </div>
            <form id="auth-form" class="mt-8 space-y-4">
                <div>
                    <input type="email" id="auth-email" placeholder="E-mail adresa" required
                           class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                </div>
                <div>
                    <input type="password" id="auth-password" placeholder="Lozinka" required
                           class="w-full px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">
                </div>
                <button type="submit" id="auth-button"
                        class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                    Prijavi se
                </button>
            </form>
            <div class="text-center mt-4">
                <button id="auth-toggle" class="text-sm text-indigo-600 hover:underline">Nemate raƒçun? Registrirajte se</button>
            </div>
        </div>
    </div>

    <!-- Glavni kontejner aplikacije -->
    <div id="app-container" class="min-h-screen p-4 hidden">
        <header class="flex justify-between items-center py-4 px-2">
            <h1 id="main-title" class="text-2xl font-bold text-gray-900 dark:text-white">Moji lijekovi</h1>
            <div class="flex space-x-2">
                <button id="add-medicine-button" class="p-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 transition-colors">
                    <i class="fas fa-plus"></i>
                </button>
                <button id="dark-mode-toggle" class="p-2 rounded-full bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline"></i>
                </button>
                <button id="logout-button" class="p-2 rounded-full bg-red-600 text-white hover:bg-red-700 transition-colors">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <main id="medicines-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-8"></main>

        <div id="no-medicines-message" class="text-center text-gray-500 dark:text-gray-400 mt-8 hidden">
            <p>Jo≈° nema dodanih lijekova. Dodaj novi podsjetnik!</p>
        </div>
    </div>

    <!-- Modal za dodavanje/ureƒëivanje -->
    <div id="add-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Dodaj novi lijek</h2>
            <form id="medicine-form" class="space-y-4">
                <div>
                    <label for="medicine-name" class="block text-gray-700 dark:text-gray-300 font-medium mb-1">Ime lijeka</label>
                    <input type="text" id="medicine-name" required
                           class="w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-600">
                </div>
                <div>
                    <label for="medicine-type" class="block text-gray-700 dark:text-gray-300 font-medium mb-1">Vrsta lijeka</label>
                    <select id="medicine-type" required
                            class="w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-600">
                        <option value="tableta">üíä Tableta</option>
                        <option value="sirup">üß¥ Sirup</option>
                        <option value="sprej">üëÉ Sprej</option>
                        <option value="injekcija">üíâ Injekcija</option>
                    </select>
                </div>
                <div>
                    <label for="medicine-times" class="block text-gray-700 dark:text-gray-300 font-medium mb-1">Vrijeme (razdvojeno zarezom)</label>
                    <input type="text" id="medicine-times" required placeholder="08:00, 14:30, 20:00"
                           class="w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-600">
                </div>
                <div>
                    <label for="start-date" class="block text-gray-700 dark:text-gray-300 font-medium mb-1">Datum poƒçetka</label>
                    <input type="date" id="start-date" required
                           class="w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-600">
                </div>
                <div>
                    <label for="end-date" class="block text-gray-700 dark:text-gray-300 font-medium mb-1">Datum kraja</label>
                    <input type="date" id="end-date" required
                           class="w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-600">
                </div>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" id="cancel-button" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg font-semibold hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors">Odustani</button>
                    <button type="submit" id="save-button" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Spremi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Prilagoƒëeni modal za poruke -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-full max-w-xs text-center">
            <p id="custom-modal-message" class="text-gray-800 dark:text-gray-200 mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="custom-modal-ok" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-colors hidden">OK</button>
                <button id="custom-modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 hidden">Odustani</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Globalne varijable koje osigurava okru≈æenje
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const translations = {
            hr: {
                mainTitle: 'Moji lijekovi',
                noMedicinesText: 'Jo≈° nema dodanih lijekova. Dodaj novi podsjetnik!',
                authTitleLogin: 'Prijava',
                authTitleRegister: 'Registracija',
                authToggleLogin: 'Nemate raƒçun? Registrirajte se',
                authToggleRegister: 'Veƒá imate raƒçun? Prijavite se',
                authSubmitLogin: 'Prijavi se',
                authSubmitRegister: 'Registriraj se',
                modalTitleAdd: 'Dodaj novi lijek',
                modalTitleEdit: 'Uredi lijek',
                labelName: 'Ime lijeka',
                labelTimes: 'Vrijeme (razdvojeno zarezom)',
                labelStartDate: 'Datum poƒçetka',
                labelEndDate: 'Datum kraja',
                labelType: 'Vrsta lijeka',
                buttonCancel: 'Odustani',
                buttonSave: 'Spremi',
                buttonUpdate: 'A≈æuriraj',
                errorAuth: 'Gre≈°ka pri autentifikaciji:',
                successLogout: 'Uspje≈°no ste se odjavili.',
                deleteConfirm: 'Jeste li sigurni da ≈æelite obrisati ovaj podsjetnik?',
                errorDelete: 'Gre≈°ka pri brisanju podsjetnika:',
                errorSave: 'Gre≈°ka pri spremanju podataka:',
                errorDataLoad: 'Gre≈°ka pri uƒçitavanju podataka:',
                pillTaken: 'Uzeto!',
                pillUnTaken: 'Oznaƒçite kao uzeto'
            }
        };

        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authButton = document.getElementById('auth-button');
        const authToggle = document.getElementById('auth-toggle');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const medicinesList = document.getElementById('medicines-list');
        const noMedicinesMessage = document.getElementById('no-medicines-message');
        const addModal = document.getElementById('add-modal');
        const addMedicineButton = document.getElementById('add-medicine-button');
        const logoutButton = document.getElementById('logout-button');
        const medicineNameInput = document.getElementById('medicine-name');
        const medicineTimesInput = document.getElementById('medicine-times');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const medicineTypeInput = document.getElementById('medicine-type');
        const cancelButton = document.getElementById('cancel-button');
        const saveButton = document.getElementById('save-button');
        const modalTitle = document.getElementById('modal-title');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const customModal = document.getElementById('custom-modal');
        const customModalMessage = document.getElementById('custom-modal-message');
        const customModalOk = document.getElementById('custom-modal-ok');
        const customModalCancel = document.getElementById('custom-modal-cancel');

        let isLogin = true;
        let editId = null;
        let currentUserId = null;
        let currentLanguage = 'hr';

        // Inicijalizacija Firebasea
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Funkcija za prikaz prilagoƒëenog modalnog prozora
        function showCustomModal(message, isConfirm = false) {
            customModalMessage.textContent = message;
            customModal.classList.remove('hidden');
            customModal.classList.add('open');

            if (isConfirm) {
                customModalOk.classList.remove('hidden');
                customModalCancel.classList.remove('hidden');
            } else {
                customModalOk.classList.remove('hidden');
                customModalCancel.classList.add('hidden');
            }
        }

        function closeCustomModal() {
            customModal.classList.remove('open');
            customModal.classList.add('hidden');
        }

        customModalOk.addEventListener('click', () => closeCustomModal());
        customModalCancel.addEventListener('click', () => closeCustomModal());

        // Prijava/Registracija
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmail.value;
            const password = authPassword.value;

            try {
                if (isLogin) {
                    await signInWithEmailAndPassword(auth, email, password);
                    showCustomModal('Uspje≈°na prijava!');
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showCustomModal('Uspje≈°na registracija!');
                }
            } catch (error) {
                let errorMessage = '';
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage = 'Neispravan format e-mail adrese.';
                        break;
                    case 'auth/wrong-password':
                    case 'auth/user-not-found':
                        errorMessage = 'Pogre≈°na e-mail adresa ili lozinka.';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = 'Ova e-mail adresa je veƒá u upotrebi.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Lozinka mora imati barem 6 znakova.';
                        break;
                    default:
                        errorMessage = `Gre≈°ka: ${error.message}`;
                        break;
                }
                showCustomModal(`${translations[currentLanguage].errorAuth} ${errorMessage}`);
            }
        });

        authToggle.addEventListener('click', () => {
            isLogin = !isLogin;
            if (isLogin) {
                authTitle.textContent = translations[currentLanguage].authTitleLogin;
                authButton.textContent = translations[currentLanguage].authSubmitLogin;
                authToggle.textContent = translations[currentLanguage].authToggleLogin;
            } else {
                authTitle.textContent = translations[currentLanguage].authTitleRegister;
                authButton.textContent = translations[currentLanguage].authSubmitRegister;
                authToggle.textContent = translations[currentLanguage].authToggleRegister;
            }
        });

        // Praƒáenje promjena u stanju autentifikacije
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                // Prikaz ID-a korisnika
                const userIdDisplay = document.createElement('p');
                userIdDisplay.textContent = `ID korisnika: ${currentUserId}`;
                userIdDisplay.classList.add('text-xs', 'text-center', 'text-gray-500', 'dark:text-gray-400', 'mt-4');
                appContainer.prepend(userIdDisplay);

                // Dohvaƒáanje podataka o lijekovima
                loadMedicines();
            } else {
                currentUserId = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });
        
        // Prijavljivanje s inicijalnim tokenom
        if (initialAuthToken) {
            try {
                await signInWithCustomToken(auth, initialAuthToken);
            } catch (e) {
                await signInAnonymously(auth);
            }
        } else {
            await signInAnonymously(auth);
        }

        // Odjava
        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showCustomModal(translations[currentLanguage].successLogout);
            } catch (error) {
                showCustomModal(`${translations[currentLanguage].errorAuth} ${error.message}`);
            }
        });

        // Funkcija za uƒçitavanje podataka iz Firestore-a
        function loadMedicines() {
            if (!currentUserId) return;
            const q = query(collection(db, `/artifacts/${appId}/users/${currentUserId}/medicines`));
            
            onSnapshot(q, (snapshot) => {
                medicinesList.innerHTML = '';
                const medicines = [];
                if (snapshot.empty) {
                    noMedicinesMessage.classList.remove('hidden');
                } else {
                    noMedicinesMessage.classList.add('hidden');
                    snapshot.forEach((doc) => {
                        medicines.push({ id: doc.id, ...doc.data() });
                    });
                    renderMedicines(medicines);
                }
            }, (error) => {
                showCustomModal(`${translations[currentLanguage].errorDataLoad} ${error.message}`);
            });
        }

        // Prikaz lijekova
        function renderMedicines(medicines) {
            medicinesList.innerHTML = '';
            const medicineTypes = {
                'tableta': 'üíä',
                'sirup': 'üß¥',
                'sprej': 'üëÉ',
                'injekcija': 'üíâ'
            };
            medicines.forEach(medicine => {
                const card = document.createElement('div');
                card.id = medicine.id;
                card.classList.add('card-container', 'bg-white', 'dark:bg-gray-800', 'rounded-2xl', 'shadow-lg', 'p-6');
                
                let timesHtml = medicine.times.map(time => `<span class="inline-block bg-indigo-100 text-indigo-800 text-xs font-semibold px-2.5 py-0.5 rounded-full dark:bg-indigo-900 dark:text-indigo-300">${time}</span>`).join(' ');

                card.innerHTML = `
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="text-3xl">${medicineTypes[medicine.type] || '‚ùì'}</div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">${medicine.name}</h3>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        ${timesHtml}
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        Od: ${medicine.startDate} do: ${medicine.endDate}
                    </p>
                    <div class="flex justify-end space-x-2 mt-4">
                        <button class="edit-button p-2 rounded-full text-blue-600 hover:bg-blue-100 transition-colors">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-button p-2 rounded-full text-red-600 hover:bg-red-100 transition-colors">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                medicinesList.appendChild(card);
            });
            setupCardEventListeners();
        }

        // Otvaranje/zatvaranje modala za dodavanje/ureƒëivanje
        addMedicineButton.addEventListener('click', () => {
            editId = null;
            modalTitle.textContent = translations[currentLanguage].modalTitleAdd;
            saveButton.textContent = translations[currentLanguage].buttonSave;
            addModal.classList.remove('hidden');
            addModal.classList.add('open');
            document.getElementById('medicine-form').reset();
        });

        cancelButton.addEventListener('click', () => {
            addModal.classList.remove('open');
            addModal.classList.add('hidden');
        });

        // Spremanje/a≈æuriranje lijeka
        document.getElementById('medicine-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const medicineName = medicineNameInput.value;
            const medicineTimes = medicineTimesInput.value.split(',').map(t => t.trim());
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const medicineType = medicineTypeInput.value;

            const medicineData = {
                name: medicineName,
                times: medicineTimes,
                startDate: startDate,
                endDate: endDate,
                type: medicineType
            };

            try {
                if (editId) {
                    const docRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/medicines`, editId);
                    await setDoc(docRef, medicineData);
                } else {
                    await addDoc(collection(db, `/artifacts/${appId}/users/${currentUserId}/medicines`), medicineData);
                }
                addModal.classList.remove('open');
                addModal.classList.add('hidden');
                document.getElementById('medicine-form').reset();
                showCustomModal('Podaci uspje≈°no spremljeni!');
            } catch (e) {
                showCustomModal(`${translations[currentLanguage].errorSave} ${e.message}`);
            }
        });

        function setupCardEventListeners() {
            document.querySelectorAll('.edit-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.closest('.card-container').id;
                    editId = id;
                    try {
                        const docRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/medicines`, id);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            medicineNameInput.value = data.name;
                            medicineTimesInput.value = data.times.join(', ');
                            startDateInput.value = data.startDate;
                            endDateInput.value = data.endDate;
                            medicineTypeInput.value = data.type;
                            modalTitle.textContent = translations[currentLanguage].modalTitleEdit;
                            saveButton.textContent = translations[currentLanguage].buttonUpdate;
                            addModal.classList.remove('hidden');
                            addModal.classList.add('open');
                        }
                    } catch (e) {
                        showCustomModal(`${translations[currentLanguage].errorDataLoad} ${e.message}`);
                    }
                });
            });

            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.closest('.card-container').id;
                    showCustomModal(translations[currentLanguage].deleteConfirm, true);
                    const handleConfirm = async (confirm) => {
                        closeCustomModal();
                        if (confirm) {
                            try {
                                await deleteDoc(doc(db, `/artifacts/${appId}/users/${currentUserId}/medicines`, id));
                                showCustomModal('Podsjetnik uspje≈°no obrisan.');
                            } catch (e) {
                                showCustomModal(`${translations[currentLanguage].errorDelete} ${e.message}`);
                            }
                        }
                    };
                    customModalOk.addEventListener('click', () => handleConfirm(true), { once: true });
                    customModalCancel.addEventListener('click', () => handleConfirm(false), { once: true });
                });
            });
        }

        // Tamni mod
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            if (document.body.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        });

        // Inicijalna provjera teme
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.body.classList.add('dark');
        } else {
            document.body.classList.remove('dark');
        }

    </script>
</body>
</html>
